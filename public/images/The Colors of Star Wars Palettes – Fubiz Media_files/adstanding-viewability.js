/*! AdStanding.Viewability | Copyright (c) Atedra Inc. */

AdStanding.requireJS.define(["jquery"],function(e){return AdStanding.Viewability=AdStanding.Viewability||{},function(){var t=this;this.$=e,this.trackers=[],this.interval=null,this.interval_milliseconds=100,this.focused=!0,this.Tracker=function(e,n){this.controller=t,this.zone=e,this.element=n,this.viewed=!1,this.clicked=!1,this.refreshed=!1,this.milliseconds={total:0,viewable:{total:0,consecutive:0,threshold:(e.is_video?2:1)*1e3}},this.bindClickEvent=function(){if(this.element){var e=this,t=function(){e.recordClickEvent()};this.element.tagName==="IFRAME"?setTimeout(function(){e.controller.bindEvent(e.element.contentWindow,"click",t)},100):e.controller.bindEvent(this.element,"click",t)}},this.recordClickEvent=function(){this.clicked||(this.clicked=!0,this.recordViewEvent(),AdStanding.recordClickData(this.zone,Math.round(this.milliseconds.viewable.total/1e3),Math.round(this.milliseconds.total/1e3)))},this.recordViewEvent=function(){this.viewed||(this.viewed=!0,AdStanding.recordViewEvent(this.zone))},this.refreshZone=function(){this.zone.is_video||this.refreshed||(this.refreshed=!0,AdStanding.refreshZone(this.zone))},this.reset=function(){this.milliseconds.viewable.total=0,this.milliseconds.viewable.consecutive=0,this.milliseconds.total=0,this.viewed=!1,this.clicked=!1,this.refreshed=!1},this.run=function(){this.milliseconds.total+=this.controller.interval_milliseconds,this.isViewable()?(this.milliseconds.viewable.total+=this.controller.interval_milliseconds,this.milliseconds.viewable.consecutive+=this.controller.interval_milliseconds):this.milliseconds.viewable.consecutive=0,!this.viewed&&this.milliseconds.viewable.consecutive>=this.milliseconds.viewable.threshold&&this.recordViewEvent();var e=this.zone.auto_refresh_delay?this.zone.auto_refresh_delay*60*1e3:0;e>0&&this.milliseconds.viewable.total>e&&this.refreshZone()},this.isViewable=function(){return this.zone.is_video&&this.zone.adstanding_video_instance.flowplayerApi&&!this.zone.adstanding_video_instance.flowplayerApi.playing?!1:this.controller.isElementViewable(this.element)&&this.controller.isClickable(this.element)}},this.recordZoneViewEvent=function(e){e.view_tracker===undefined&&(e.view_tracker=new AdStanding.Viewability.Tracker(e,null)),e.view_tracker.recordViewEvent()},this.addZone=function(e,t){e.view_tracker===undefined&&(e.view_tracker=new AdStanding.Viewability.Tracker(e,t),this.add(e.view_tracker)),e.view_tracker.reset(),e.view_tracker.bindClickEvent()},this.removeZone=function(e){this.remove(e.view_tracker)},this.setup=function(){var e=this,t=function(){e.track(e)};this.interval=window.setInterval(t,this.interval_milliseconds),this.isTopWindowReachable()&&(this.bindEvent(this.getTopWindow(),"focus",function(){e.focused=!0}),this.bindEvent(this.getTopWindow(),"blur",function(){e.focused=!1}))},this.teardown=function(){window.clearInterval(this.interval)},this.add=function(e){this.trackers.length===0&&this.setup(),this.trackers.push(e)},this.remove=function(e){var t=this.$.inArray(e,this.trackers);t>-1&&this.trackers.splice(t,1),this.trackers.length===0&&this.teardown()},this.track=function(e){var t=[];e.$.each(e.trackers,function(n,r){try{typeof r=="function"?r():r.element&&r.run()}catch(i){t.push(r),e.log(i.message)}}),e.$.each(t,function(t,n){e.remove(n)})},this.isElementViewable=function(e,t){if(this.isTopWindowReachable()&&(this.focused||this.isInFamilyTree(this.getTopWindowElement(e),window.top.document.activeElement))){var n=t||.5;return this.getVisibilityRatio(e)>=n}return!1},this.isTopWindowReachable=function(){try{var e=window.top.document;return!0}catch(t){return!1}},this.isMeasureable=function(){return this.isTopWindowReachable()},this.getElementRectangle=function(e){var t=this.getTopWindowElement(e).getBoundingClientRect(),n={top:t.top,right:t.right,bottom:t.bottom,left:t.left};return n.top==n.bottom&&n.bottom++,n.left==n.right&&n.right++,n},this.getViewportRectangle=function(){var e=this.getTopWindow();return{left:0,top:0,right:e.innerWidth||e.document.documentElement.clientWidth,bottom:e.innerHeight||e.document.documentElement.clientHeight}},this.isClickable=function(e){var t=this.getElementRectangle(e),n=t.left+(t.right-t.left)/2,r=t.top+(t.bottom-t.top)/2,i=this.getTopWindow().document.elementFromPoint(n,r);return this.isInFamilyTree(this.getTopWindowElement(e),i)},this.isInFamilyTree=function(e,t){while(t){if(t===e)return!0;t=t.parentNode}return!1},this.getRectangleIntersect=function(e,t){var n=Math.max(e.top,t.top),r=Math.min(e.bottom,t.bottom),i=Math.max(e.left,t.left),s=Math.min(e.right,t.right);return s>=i&&r>=n?{top:n,right:s,bottom:r,left:i}:{top:0,right:0,bottom:0,left:0}},this.getPixelArea=function(e){return Math.max(.5,e.right-e.left)*(e.bottom-e.top)},this.getVisibilityRatio=function(e){var t=this.getElementRectangle(e),n=this.getRectangleIntersect(t,this.getViewportRectangle());return this.getPixelArea(n)/this.getPixelArea(t)},this.getTopWindow=function(){var e=window;while(e!=window.top)e=e.parent;return e},this.getTopWindowElement=function(e){var t=e.ownerDocument,n=t.defaultView||t.parentWindow;while(n!=window.top)e=n.frameElement,n=n.parent;return e},this.logRectangle=function(e){var t=e,n=function(e){return("      "+parseInt(e,10)).slice(-6)};this.log("top: "+n(t.top)+", left: "+n(t.left)+", bottom: "+n(t.bottom)+", right: "+n(t.right))},this.bindEvent=function(e,t,n){try{e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n)}catch(r){}},this.log=function(e){console&&console.log("adstanding.viewability: "+e)}}.apply(AdStanding.Viewability),AdStanding.Viewability});