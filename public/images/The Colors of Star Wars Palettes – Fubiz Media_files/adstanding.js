/*! AdStanding | Copyright (c) Atedra Inc. */

AdStanding.requireJS.define(["flashdetect","jquery","jquery-xdomainrequest","adstanding-viewability"],function(e,t,n,r){return function(){this.loaded=!0,this.loading=!1,this.process_zone_after_load=!1,this.is_new_pageview=!0,this.$=t,this.cookie=navigator.cookieEnabled,this.flash=e.installed,this.flash_version=e.major+"."+e.minor,this.campaigns=this.campaigns||[],this.uri=location.hostname+location.pathname+location.search,this.referrer=document.referrer,this.zones=this.zones||[],this.visitor_id="",this.keywords=this.$("meta[name=keywords]").attr("content"),this.is_tablet=!1,this.is_mobile=!1,this.splash_displayed=!1,this.dnt=!1,this.document_ready=!1,this.accelerated_zones=this.accelerated_zones||3,typeof navigator.doNotTrack!="undefined"?this.dnt=navigator.doNotTrack==1||navigator.doNotTrack=="yes":typeof navigator.msDoNotTrack!="undefined"?this.dnt=navigator.msDoNotTrack==1||navigator.msDoNotTrack=="yes":typeof window.doNotTrack!="undefined"&&(this.dnt=window.doNotTrack==1||window.doNotTrack=="yes"),this.createCookie=function(e,t,n){var r="";if(n){var i=new Date;i.setTime(i.getTime()+n*60*60*1e3),r="; expires="+i.toUTCString()}document.cookie=e+"="+t+r+"; path=/"},this.readCookie=function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null},this.addCampaigns=function(e){this.campaigns=this.uniqueIds(this.campaigns.concat(e))},this.getCampaigns=function(){var e=this.$.map(this.zones,function(e){return e.campaign_id});return e=this.uniqueIds(this.campaigns.concat(e)),e},this.uniqueIds=function(e){var t=[];for(var n=0;n<e.length;n++){var r=parseInt(e[n],10);r&&t.indexOf(r)===-1&&t.push(r)}return t},this.refreshZone=function(e){e.viewed_campaign_ids.push(e.campaign_id),e.is_refreshing=!0,this.load([e])},this.execute=function(){var e=this;e.processAcceleratedZones(),this.$(AdStanding.document).ready(function(){e.document_ready=!0,e.processZones()})},this.executePassback=function(e,t){var n=this.$.grep(this.zones,function(t){return t.zone_id==e}).shift();n&&(n.parent_chain_object_id=t,this.load([n]))},this.buildZoneParameters=function(e){var n=this,r={zone_id:e.zone_id,placement_id:e.placement_id,html_id:e.html_id,click_tracker:e.click_tracker,parent_chain_object_id:e.parent_chain_object_id,viewed_campaign_ids:e.viewed_campaign_ids||[],is_refreshing:e.is_refreshing,refresh_campaign_media_id:e.refresh_campaign_media_id,is_undetermined_impression:!AdStanding.Viewability.isMeasureable()};delete e.parent_chain_object_id,e.time_offset&&(r.time_offset=e.time_offset),e.execution_time&&(r.execution_time=e.execution_time),e.is_dooh_player&&(r.is_dooh_player=e.is_dooh_player),e.campaign_media_id&&(r.campaign_media_id=e.campaign_media_id);if(e.video){var i=t.extend({},e.video);delete i.onFinish,r.video=i}return r},this.processZones=function(){var e=this;if(this.loading){this.process_zone_after_load=!0;return}var t=this.$.grep(this.zones,function(t){var n=t.skip,r=t.loaded;return e.document_ready&&(t.skip=!1,t.loaded=!0),!n&&!r});this.processed=!0,t.length&&this.load(t)},this.processAcceleratedZones=function(){if(this.acceleration_processed)return;var e=this.$.grep(this.zones,function(e){var t=e.skip,n=e.loaded,r=e.accelerated||!1;return!t&&!n&&r});e.length>=this.accelerated_zones&&(this.$.each(e,function(e,t){t.loaded=!0}),this.acceleration_processed=!0,this.loading=!0,this.load(e))},this.refreshIframes=function(e){var t=this,n=this.$.isArray(e)?e:arguments,r=this.$.grep(this.zones,function(e){return t.$.inArray(e.html_id,n)>-1});this.is_new_pageview=1,this.load(r)},this.load=function(e,t){var n=this,r={c:n.cookie,f:n.flash,fv:n.flash_version,dc:n.getCampaigns().join(","),u:n.uri,rf:n.referrer,vi:n.readCookie("_adstanding_local_id"),kw:n.keywords,dnt:n.dnt,npv:n.is_new_pageview,secure:AdStanding.window.location.protocol==="https:",zones:[]};this.is_new_pageview=0,this.$.each(e,function(e,t){r.zones.push(n.buildZoneParameters(t))});var i=JSON.stringify(r);this.$.ajax("https://"+n.server+"/zones.php",{data:i,type:"POST",async:!0,cache:!1,crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(e,r,i){n.loading=!1,i.status==200?(n.visitor_id=e.vi,n.is_tablet=e.is_tablet,n.is_mobile=e.is_mobile,n.render(e.zones,t),n.synchronizeCookies(e.vi),n.dropPixels(e.pixels),n.dropIframes(e.iframes),n.addCampaigns(e.dc)):t(!1),n.process_zone_after_load&&(n.process_zone_after_load=!1,n.processZones())},error:function(e,r,i){n.loading=!1,n.log(r+":"+i),n.process_zone_after_load&&(n.process_zone_after_load=!1,n.processZones()),t&&t(!1)}})},this.render=function(e,t){var n=this,r=e.length,i=function(){r--,r==0&&t&&t(!0)};this.$.each(e,function(e,t){var r=n.getZoneByHtmlId(t.html_id);t.content?t.content.indexOf("<?xml")==0?n.renderVideo(r,t,i):n.renderIframe(r,t,i):t.video&&t.video.is_capped?n.renderVideo(r,t,i):r.rendered?(AdStanding.Viewability.removeZone(r),i()):n.renderIframe(r,t,i)})},this.getZoneByHtmlId=function(e){for(var t=0;t<this.zones.length;t++){var n=this.zones[t];if(n.html_id==e)return n}return null},this.renderIframe=function(e,t,n){this.$.extend(!0,e,t),e.rendered=!0,e.is_video=!1;if(e.content==null){n();return}e.content.indexOf("AdStanding.Background")!=-1?(AdStanding.Background=AdStanding.Background||{},AdStanding.Background.zone=e):e.content.indexOf("AdStandingInImage")!=-1?(AdStanding.window.AdStandingInImage=AdStanding.window.AdStandingInImage||{},AdStanding.window.AdStandingInImage.zone=e):e.content.indexOf("AdStanding.Catfish")!=-1||e.type=="mobile_catfish"?(AdStanding.Catfish=AdStanding.Catfish||{},AdStanding.Catfish.zone=e):e.content.indexOf("AdStanding.SplashImage")!=-1&&(AdStanding.SplashImage=AdStanding.SplashImage||{},AdStanding.SplashImage.zone=e);var r;e.full_page?r=e.content:(r="<!DOCTYPE html>",r+="<html>",r+=" <head>",r+='  <meta charset="utf-8">',r+='  <script type="text/javascript">',r+="   var inDapIF=true;",r+="  </script>",r+=" </head>",r+=' <body style="margin:0; padding:0;">',r+=e.content,r+=" </body>",r+="</html>");var i=e.window.document.getElementById(e.html_id),s=[i];e.resize_parent_iframes&&(s=s.concat(e.frames)),this.resizeIframes(s,e.width,e.height),e.type=="mobile_catfish"?(AdStanding.Catfish.options={mobile:!0,width:e.width,height:e.height,closeButton:{width:18,height:18,top:2,right:2}},AdStanding.requireJS.require(["catfish"],function(e){e.executeMobileScript(r,i),n()})):(i.onload=n,this.writeIframe(i,r),e.width>1&&e.height>1&&(i.style.display="inline",e.type!="digital_billboard"&&AdStanding.Viewability.addZone(e,i)))},this.renderVideo=function(e,t,n){this.$.extend(!0,e,t),e.rendered=!0,e.is_video=!0,AdStanding.requireJS.require(["adstanding-video"],function(t){t.execute(e),n()})},this.resizeIframes=function(e,t,n){this.$.each(e,function(e,r){t&&(r.width=t,r.style.width=t+"px"),n&&(r.height=n,r.style.height=n+"px")})},this.writeIframe=function(e,t){this.$.support.cors?(e.contentWindow.document.open("text/html","replace"),e.contentWindow.document.write(t),e.contentWindow.document.close()):(e.contentWindow.contents=t,e.src='javascript:window["contents"]')},this.recordViewEvent=function(e){if(e.viewed_impression_url){var t=this,n={u:t.uri,vi:t.visitor_id,coi:e.chain_object_id};this.$.ajax(e.viewed_impression_url,{data:n,type:"POST",async:!0,cache:!1,crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},error:function(e,n,r){t.log(n+":"+r)}})}},this.recordClickData=function(e,t,n){if(e.click_data_url){var r=this,i={u:r.uri,vi:r.visitor_id,cvd:t,ctd:n};this.$.ajax(e.click_data_url,{data:i,type:"POST",async:!0,cache:!1,crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},error:function(e,t,n){r.log(t+":"+n)}})}},this.synchronizeCookies=function(e){this.readCookie("_adstanding_local_id")!=e&&this.createCookie("_adstanding_local_id",e,8760)},this.dropPixels=function(e){var t=this;this.$.each(e,function(e,n){var r=t.$("<img>");r.css({width:0,height:0,display:"none",margin:0,padding:0}),r.attr({src:n,border:0}),t.$("body").append(r)})},this.dropIframes=function(e){var t=this;this.$.each(e,function(e,n){var r=t.$("<iframe>");r.css({width:0,height:0,display:"none",margin:0,padding:0}),r.attr({src:n,frameborder:0}),t.$("body").append(r)})},this.isMobile=function(){return this.is_mobile},this.isTablet=function(){return this.is_tablet},this.log=function(e){console&&console.log("adstanding: "+e)}}.apply(AdStanding),AdStanding});